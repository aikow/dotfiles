#!/usr/bin/env bash

set -o nounset
set -o pipefail

# Dotfile-wide variables begin with DOTFILES_
# These should also be set as environment variables in the shell
export DOTFILES_HOME=$PWD
export DOTFILES_BIN=$DOTFILES_HOME/bin

# Add the local bin directory to the path
PATH=$DOTFILES_BIN:$PATH

# Installation specific variables used soley by dotbot scripts during setup
# begin with DOTBOT_
export DOTBOT_FORCE=${DOTBOT_FORCE:-no}
DOTBOT_OS="$(uname -o | tr '[:upper:]' '[:lower:]')"
export DOTBOT_OS
export DOTBOT_OS_SHORT=${DOTBOT_OS##*/}

run() {
  local config_path=$1

  local config_dir
  config_dir="$(dirname "$config_path")"
  local config
  config="$(basename "$config_path")"

  local name=${config_dir##*/}

  if [[ ! -f $config_path ]]; then
    echo "($name)(3) file does not exist"
    return 1
  fi

  local old_pwd=$PWD
  cd "$config_dir" || exit

  bash "$config"
  local exitcode=$?

  if [[ $exitcode -eq 0 ]]; then
    echo "($name) installed"
  elif [[ $exitcode -lt 128 ]]; then
    echo "($name)($exitcode) installation failed"
  else
    local errmsg
    case "$exitcode" in
      128) errmsg="command not installed - skipping" ;;
      129) errmsg="unsupported OS '$DOTBOT_OS' - skipping" ;;
      *) errmsg="unknown dotbot error - skipping" ;;
    esac
    echo "($name)($exitcode) $errmsg"
  fi

  cd "$old_pwd" || exit

  return "$exitcode"
}

run_all() {
  run dotbot

  for config_dotbot in config/*/dotbot; do
    run "$config_dotbot"
  done
}

main() {
  if [[ $# -eq 1 && $1 == "all" ]]; then
    # Usage: ./install all
    # Installs all configs
    run_all
  elif [[ $# -ge 1 ]]; then
    # Usage: ./install config/alacritty/dotbot
    # Only install configs explicitly listed as CLI arguments.
    for config_dotbot in "$@"; do
      run "$config_dotbot"
    done
  else
    # Usage: ./install
    # Install all configs
    run_all
  fi
}

main "$@"
